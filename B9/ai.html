<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Obfuscated Password Input</title>
    <style>
      /* Basic styles for demonstration */
      html,
      body {
        height: 100%;
        margin: 0;
        display: grid;
        place-items: center;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f0f2f5;
      }

      /* Container for the input and button */
      .password-container {
        position: relative;
        width: 300px;
      }

      #passwordInput {
        width: 100%;
        padding: 12px 70px 12px 12px; /* Make space for the button */
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box; /* Important for layout */
        /* Use a monospace font so all symbols take equal space */
        font-family: "Courier New", Courier, monospace;
      }

      #toggleButton {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
      }

      #toggleButton:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="password-container">
      <input type="text" id="passwordInput" placeholder="Enter password" />
      <button id="toggleButton">Show</button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /**@type {HTMLInputElement} */
        const passwordInput = document.getElementById("passwordInput");
        /**@type {HTMLButtonElement} */
        const toggleButton = document.getElementById("toggleButton");

        // --- State ---
        let realPassword = "";
        let obfuscatedPassword = "";
        let isShowing = false;
        const symbols = "~!@#$%^&*()_+-=[]{}|;':\",./<>?";

        // --- Helper Functions ---

        /** Gets a random symbol from our list. */
        function getRandomSymbol() {
          return symbols[Math.floor(Math.random() * symbols.length)];
        }

        /** Updates the visible input value based on the 'isShowing' state. */
        function updateInputValue() {
          if (isShowing) {
            passwordInput.value = realPassword;
          } else {
            passwordInput.value = obfuscatedPassword;
          }
        }

        // --- Event Listeners ---

        /**
         * Toggle Button Click
         * Flips the 'isShowing' state and updates the input.
         */
        toggleButton.addEventListener("click", () => {
          isShowing = !isShowing;

          if (isShowing) {
            toggleButton.textContent = "Hide";
          } else {
            toggleButton.textContent = "Show";
            // Re-randomize the symbols every time we hide, just like the demo video
            // obfuscatedPassword = Array.from(realPassword)
            //   .map(() => getRandomSymbol())
            //   .join("");
          }

          // Update the visible text and maintain cursor position
          const cursorPosition = passwordInput.selectionStart;
          updateInputValue();
          passwordInput.focus();
          passwordInput.setSelectionRange(cursorPosition, cursorPosition);
        });

        /**
         * Keydown Event
         * This is the core logic. We must manually handle all input
         * to keep our 'realPassword' and 'obfuscatedPassword' in sync.
         */
        passwordInput.addEventListener("keydown", (e) => {
          // Allow navigation keys (arrows, home, end) to work normally
          if (
            e.key === "ArrowLeft" ||
            e.key === "ArrowRight" ||
            e.key === "Home" ||
            e.key === "End" ||
            e.key === "Tab"
          ) {
            return;
          }

          // Allow select-all (Ctrl/Cmd + A)
          if ((e.ctrlKey || e.metaKey) && e.key === "a") {
            return;
          }

          // Prevent the default key action, as we will handle it ourselves
          e.preventDefault();

          let start = passwordInput.selectionStart;
          let end = passwordInput.selectionEnd;

          if (e.key === "Backspace") {
            if (start === end && start > 0) {
              // Single character delete
              realPassword =
                realPassword.slice(0, start - 1) + realPassword.slice(start);
              obfuscatedPassword =
                obfuscatedPassword.slice(0, start - 1) +
                obfuscatedPassword.slice(start);
              start--; // Move cursor back
            } else if (start !== end) {
              // Range delete
              realPassword =
                realPassword.slice(0, start) + realPassword.slice(end);
              obfuscatedPassword =
                obfuscatedPassword.slice(0, start) +
                obfuscatedPassword.slice(end);
            }
          } else if (e.key === "Delete") {
            if (start === end && start < realPassword.length) {
              // Single char delete
              realPassword =
                realPassword.slice(0, start) + realPassword.slice(start + 1);
              obfuscatedPassword =
                obfuscatedPassword.slice(0, start) +
                obfuscatedPassword.slice(start + 1);
            } else if (start !== end) {
              // Range delete
              realPassword =
                realPassword.slice(0, start) + realPassword.slice(end);
              obfuscatedPassword =
                obfuscatedPassword.slice(0, start) +
                obfuscatedPassword.slice(end);
            }
          } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
            // This is a printable character
            const newSymbol = getRandomSymbol();

            // Insert the new character into both strings
            realPassword =
              realPassword.slice(0, start) + e.key + realPassword.slice(end);
            obfuscatedPassword =
              obfuscatedPassword.slice(0, start) +
              newSymbol +
              obfuscatedPassword.slice(end);
            start++; // Move cursor forward
          }

          // Update the visible input
          updateInputValue();

          // Set the cursor to the correct new position
          passwordInput.setSelectionRange(start, start);
        });

        /**
         * Handle Pasting
         * We also need to intercept paste events.
         */
        passwordInput.addEventListener("paste", (e) => {
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData(
            "text"
          );
          if (!pastedText) {
            return;
          }

          let start = passwordInput.selectionStart;
          let end = passwordInput.selectionEnd;

          // Generate new symbols for the pasted text
          const newSymbols = Array.from(pastedText)
            .map(() => getRandomSymbol())
            .join("");

          // Insert the pasted text into both strings
          realPassword =
            realPassword.slice(0, start) + pastedText + realPassword.slice(end);
          obfuscatedPassword =
            obfuscatedPassword.slice(0, start) +
            newSymbols +
            obfuscatedPassword.slice(end);

          // Update cursor position
          start += pastedText.length;

          updateInputValue();
          passwordInput.setSelectionRange(start, start);
        });
      });
    </script>
  </body>
</html>
